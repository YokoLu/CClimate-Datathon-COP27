<head>
    <style>
        body {
            margin: 0;
        }
    </style>

    <script src="//unpkg.com/d3"></script>
    <script src="//unpkg.com/globe.gl"></script>
    <script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.2/lib/bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="style.css">

</head>

<body style="background-color: #d9fcfc; text-align: center;">

    <div id="size-container" class="container">
        <h1 id="header"
            style="background-color: white; text-align: center; padding-bottom: 20px; text-transform: capitalize; font-family: 'Montserrat';">
            Total Commitment Score
        </h1>

        <select class="form-select" style="font-family: 'Montserrat';" id="indicator_selector">
            <option value="TCS" selected>Total Commitment Score</option>
            <option value="TVS">Total Vulnerability Score</option>
            <option value="TPAS">Total Policies & Action Score</option>
            <option value="AD">Aggregated Data & Action Score</option>
        </select>


        <div id="globeViz" style="align-items: center;"></div>
    </div>
    <script>
        var red = "#92140C";
        var green = "#20BF55";
        var yellow = "#F2CD60";

        function resize() {
            worldWidth = window.innerWidth
            worldHeight = window.innerHeight

            var containerSize = document.querySelector('#size-container');
            padding = parseFloat(window.getComputedStyle(containerSize, null).getPropertyValue('padding-right'))

            if (worldWidth >= worldHeight) {
                world.width([containerSize.offsetWidth - padding * 2])
                world.height([worldHeight * 0.9])
            }
            else {
                world.width([containerSize.offsetWidth - padding * 2])
                world.height([worldWidth * 0.9])
            }
        }

        window.addEventListener('resize', (event) => {
            resize();
        });

        function getColorScaleTCS(x) {
            // Color Scale for Total Commitment Score
            if (x === "white" || val === null) {
                return "white";
            }
            if (Number(x) === 1) {
                return yellow;
            }
            else if (Number(x) < 1) {
                return red;
            }
            else if (Number(x) >= 2) {
                return green;
            }
            return "white";
        }

        function getColorScaleTVS(x) {
            // Color Scale for Total Vulnerability Score
            if (x === "white" || val === null) {
                return "white";
            }
            if (Number(x) >= -1 & Number(x) <= 0) {
                return yellow;
            }
            else if (Number(x) < -1) {
                return red;
            }
            else if (Number(x) > 0) {
                return green;
            }
            return "white";
        }

        function getColorScaleTPAS(x) {
            // Color Scale for Total Policies & Action Score
            if (x === "white" || val === null) {
                return "white";
            }
            if (Number(x) > -1 & Number(x) < 0) {
                return yellow;
            }
            else if (Number(x) <= -1) {
                return red;
            }
            else if (Number(x) >= 0) {
                return green;
            }
            return "white";
        }

        function getColorScaleAD(x) {
            // Color Scale for Aggregated Data & Action Score
            if (x === "white" || val === null) {
                return "white";
            }
            if (Number(x) >= -0.5 & Number(x) <= 0) {
                return yellow;
            }
            else if (Number(x) < -0.5) {
                return red;
            }
            else if (Number(x) > 0) {
                return green;
            }
            return "white";
        }

        function createVal(d) {
            try {
                val = df.iloc({ rows: df["Country"].eq(d.ADMIN) }).loc({ columns: [col] }).values
                if (val.length !== 0 && val !== null) {
                    return val
                }
            } catch (err) {
                console.log(err);
                return "white";
            }
            return "white";
        }

        var colorScale = getColorScaleTCS;
        var col = "Total commitment score";
        var df = null;
        var world = null;

        // Read CSV
        dfd.readCSV('./datasets/Final_Scores.csv').then(result => { df = result }).catch((error) => console.error(error));

        // Source: https://github.com/vasturiano/globe.gl
        fetch('./datasets/countries.geojson').then(res => res.json()).then(countries => {

            world = Globe({ rendererConfig: { antialias: false, precision: 'lowp' } })
                .globeImageUrl('//unpkg.com/three-globe/example/img/earth-day.jpg')
                .backgroundColor('#d9fcfc')
                .lineHoverPrecision(0)
                .polygonsData(countries.features.filter(d => d.properties.ISO_A2 !== 'AQ'))
                .polygonAltitude(0.03)
                .polygonCapColor(({ properties: d }) => colorScale(createVal(d)))
                .polygonSideColor(() => 'rgba(0, 10, 0, 0.15)')
                .polygonStrokeColor(({ properties: d }) => "white")
                .polygonLabel(({ properties: d }) => `
                    <b>${d.ADMIN} (${d.ISO_A2}):</b> <br />
                    ${col}: <i>${df.iloc({ rows: df["Country"].eq(d.ADMIN) }).loc({ columns: [col] }).values}</i>
                    `
                )
                .onPolygonHover(hoverD => world
                    .polygonAltitude(d => d === hoverD ? 0.12 : 0.06)
                )
                .polygonsTransitionDuration(300)
                (document.getElementById('globeViz'))

            resize();
        });

        document.getElementById('indicator_selector').addEventListener('change', function () {
            'use strict';
            var vis = document.querySelector('.vis');
            var indicator_selector = document.getElementById('indicator_selector').value;
            var header = document.getElementById('header');

            if (indicator_selector === 'TCS') {
                console.log("TCS");
                colorScale = getColorScaleTCS;
                col = "Total commitment score";
                header.textContent = col;
            }
            else if (indicator_selector === 'TVS') {
                console.log("TVS");
                colorScale = getColorScaleTVS;
                col = "Total vulnerability score";
                header.textContent = col;
            }
            else if (indicator_selector === 'TPAS') {
                console.log("TPAS");
                colorScale = getColorScaleTPAS;
                col = "Total policies and action score";
                header.textContent = col;
            }
            else if (indicator_selector === 'AD') {
                console.log("AD");
                colorScale = getColorScaleAD;
                col = "Aggregated data";
                header.textContent = col;
            }

            function changeIndicator() {
                world
                    .polygonCapColor(({ properties: d }) => colorScale(createVal(d)))
                    .polygonLabel(({ properties: d }) => `
                    <b>${d.ADMIN} (${d.ISO_A2}):</b> <br />
                    ${col}: <i>${df.iloc({ rows: df["Country"].eq(d.ADMIN) }).loc({ columns: [col] }).values}</i>
                    `);
            }

            requestAnimationFrame(changeIndicator);
        });
    </script>
</body>